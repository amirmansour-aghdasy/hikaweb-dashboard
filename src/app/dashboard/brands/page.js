"use client";
import { useState, useMemo } from "react";
import { Box, Typography, Chip, Button, Stack, Avatar, Card, CardContent, Grid, IconButton, Tooltip, Rating, Link } from "@mui/material";
import { Business, Edit, Delete, Add, Language, Email, Phone, Star, Work, TrendingUp, Visibility, LinkedIn, Twitter, Instagram } from "@mui/icons-material";
import Layout from "@/components/layout/Layout";
import DataTable from "@/components/ui/DataTable";
import Modal from "@/components/ui/Modal";
import BrandForm from "@/components/forms/BrandForm";
import { useApi } from "@/hooks/useApi";
import { useDebounce } from "@/hooks/useDebounce";
import { formatDate } from "@/lib/utils";

const INDUSTRY_CONFIG = {
    technology: { label: "ŸÅŸÜÿßŸàÿ±€å", color: "primary", icon: "üíª" },
    healthcare: { label: "ÿ®ŸáÿØÿßÿ¥ÿ™ Ÿà ÿØÿ±ŸÖÿßŸÜ", color: "success", icon: "üè•" },
    finance: { label: "ŸÖÿßŸÑ€å", color: "warning", icon: "üí∞" },
    education: { label: "ÿ¢ŸÖŸàÿ≤ÿ¥", color: "info", icon: "üéì" },
    retail: { label: "ÿÆÿ±ÿØŸá‚ÄåŸÅÿ±Ÿàÿ¥€å", color: "secondary", icon: "üõí" },
    manufacturing: { label: "ÿ™ŸàŸÑ€åÿØ€å", color: "default", icon: "üè≠" },
    services: { label: "ÿÆÿØŸÖÿßÿ™", color: "primary", icon: "üîß" },
    other: { label: "ÿ≥ÿß€åÿ±", color: "default", icon: "üè¢" },
};

const COMPANY_SIZES = {
    startup: { label: "ÿßÿ≥ÿ™ÿßÿ±ÿ™ÿßŸæ", color: "info" },
    small: { label: "⁄©Ÿà⁄Ü⁄©", color: "success" },
    medium: { label: "ŸÖÿ™Ÿàÿ≥ÿ∑", color: "warning" },
    large: { label: "ÿ®ÿ≤ÿ±⁄Ø", color: "error" },
    enterprise: { label: "ÿ≥ÿßÿ≤ŸÖÿßŸÜ€å", color: "secondary" },
};

export default function BrandsPage() {
    const [editingBrand, setEditingBrand] = useState(null);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [searchTerm, setSearchTerm] = useState("");
    const [statusFilter, setStatusFilter] = useState("all");
    const [industryFilter, setIndustryFilter] = useState("all");
    const [viewMode, setViewMode] = useState("table"); // 'table' or 'cards'

    const debouncedSearchTerm = useDebounce(searchTerm, 800);
    const { useFetchData, useUpdateData, useDeleteData } = useApi();

    // Build query params
    const queryParams = useMemo(() => {
        const params = new URLSearchParams();
        if (debouncedSearchTerm && debouncedSearchTerm.length >= 3) {
            params.append("search", debouncedSearchTerm);
        }
        if (statusFilter !== "all") {
            params.append("status", statusFilter);
        }
        if (industryFilter !== "all") {
            params.append("industry", industryFilter);
        }
        return params.toString();
    }, [debouncedSearchTerm, statusFilter, industryFilter]);

    const endpoint = `/brands${queryParams ? `?${queryParams}` : ""}`;

    // Fetch brands
    const { data: brandsData, isLoading } = useFetchData(["brands", queryParams], endpoint);

    // Update brand
    const updateBrand = useUpdateData("/brands", {
        successMessage: "ÿ®ÿ±ŸÜÿØ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ",
    });

    // Delete brand
    const deleteBrand = useDeleteData("/brands", {
        successMessage: "ÿ®ÿ±ŸÜÿØ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ",
    });

    const columns = [
        {
            field: "logo",
            headerName: "ŸÑŸà⁄ØŸà",
            width: 80,
            render: (row) => (
                <Avatar src={row.logo} variant="rounded" sx={{ width: 40, height: 40 }}>
                    <Business />
                </Avatar>
            ),
        },
        {
            field: "name",
            headerName: "ŸÜÿßŸÖ ÿ®ÿ±ŸÜÿØ",
            flex: 2,
            render: (row) => (
                <Box>
                    <Typography variant="body2" fontWeight="bold">
                        {row.name}
                    </Typography>
                    <Typography variant="caption" color="text.secondary">
                        {row.website && (
                            <Link href={row.website} target="_blank" rel="noopener">
                                {row.website.replace(/^https?:\/\//, "")}
                            </Link>
                        )}
                    </Typography>
                </Box>
            ),
        },
        {
            field: "industry",
            headerName: "ÿµŸÜÿπÿ™",
            width: 150,
            render: (row) => {
                const config = INDUSTRY_CONFIG[row.industry] || INDUSTRY_CONFIG.other;
                return <Chip label={config.label} size="small" color={config.color} icon={<span style={{ fontSize: "12px" }}>{config.icon}</span>} />;
            },
        },
        {
            field: "companySize",
            headerName: "ÿßŸÜÿØÿßÿ≤Ÿá ÿ¥ÿ±⁄©ÿ™",
            width: 120,
            render: (row) => {
                const config = COMPANY_SIZES[row.companySize] || COMPANY_SIZES.small;
                return <Chip label={config.label} size="small" color={config.color} variant="outlined" />;
            },
        },
        {
            field: "contact",
            headerName: "ÿ™ŸÖÿßÿ≥",
            width: 200,
            render: (row) => (
                <Box>
                    {row.contactPerson && (
                        <Typography variant="caption" display="block" fontWeight="bold">
                            {row.contactPerson}
                        </Typography>
                    )}
                    {row.email && (
                        <Typography variant="caption" display="block" color="text.secondary">
                            üìß {row.email}
                        </Typography>
                    )}
                    {row.phone && (
                        <Typography variant="caption" display="block" color="text.secondary">
                            üìû {row.phone}
                        </Typography>
                    )}
                </Box>
            ),
        },
        {
            field: "collaboration",
            headerName: "ŸáŸÖ⁄©ÿßÿ±€å",
            width: 150,
            render: (row) => (
                <Box>
                    {row.startDate && (
                        <Typography variant="caption" display="block">
                            ÿ¥ÿ±Ÿàÿπ: {formatDate(row.startDate)}
                        </Typography>
                    )}
                    {row.rating && <Rating value={row.rating} readOnly size="small" precision={0.5} />}
                    <Typography variant="caption" color="text.secondary">
                        {row.projectsCount || 0} Ÿæÿ±Ÿà⁄òŸá
                    </Typography>
                </Box>
            ),
        },
        {
            field: "status",
            headerName: "Ÿàÿ∂ÿπ€åÿ™",
            width: 100,
            type: "status",
        },
        {
            field: "createdAt",
            headerName: "ÿ™ÿßÿ±€åÿÆ ÿß€åÿ¨ÿßÿØ",
            width: 120,
            render: (row) => <Typography variant="caption">{formatDate(row.createdAt)}</Typography>,
        },
    ];

    const handleEdit = (brand) => {
        setEditingBrand(brand);
        setIsModalOpen(true);
    };

    const handleDelete = (brand) => {
        if (window.confirm("ÿ¢€åÿß ÿßÿ≤ ÿ≠ÿ∞ŸÅ ÿß€åŸÜ ÿ®ÿ±ŸÜÿØ ÿßÿ∑ŸÖ€åŸÜÿßŸÜ ÿØÿßÿ±€åÿØÿü")) {
            deleteBrand.mutate(brand._id);
        }
    };

    const handleToggleFeatured = (brand) => {
        updateBrand.mutate({
            id: brand._id,
            data: { isFeatured: !brand.isFeatured },
        });
    };

    const handleAdd = () => {
        setEditingBrand(null);
        setIsModalOpen(true);
    };

    const handleSearch = (searchValue) => {
        setSearchTerm(searchValue);
    };

    const handleSaveBrand = () => {
        setIsModalOpen(false);
        setEditingBrand(null);
    };

    const customActions = [
        {
            label: "ŸÖÿ¥ÿßŸáÿØŸá Ÿàÿ®‚Äåÿ≥ÿß€åÿ™",
            icon: <Language />,
            onClick: (brand) => {
                if (brand.website) {
                    window.open(brand.website, "_blank");
                }
            },
            show: (brand) => !!brand.website,
        },
        {
            label: "Ÿà€å⁄òŸá",
            icon: (brand) => (brand.isFeatured ? <Star /> : <Star style={{ opacity: 0.3 }} />),
            onClick: handleToggleFeatured,
            color: (brand) => (brand.isFeatured ? "secondary" : "default"),
        },
        {
            label: "Ÿà€åÿ±ÿß€åÿ¥",
            icon: <Edit />,
            onClick: handleEdit,
            color: "primary",
        },
        {
            label: "ÿ≠ÿ∞ŸÅ",
            icon: <Delete />,
            onClick: handleDelete,
            color: "error",
        },
    ];

    const filters = [
        {
            key: "status",
            label: "Ÿàÿ∂ÿπ€åÿ™",
            value: statusFilter,
            onChange: setStatusFilter,
            options: [
                { value: "all", label: "ŸáŸÖŸá" },
                { value: "active", label: "ŸÅÿπÿßŸÑ" },
                { value: "inactive", label: "ÿ∫€åÿ±ŸÅÿπÿßŸÑ" },
            ],
        },
        {
            key: "industry",
            label: "ÿµŸÜÿπÿ™",
            value: industryFilter,
            onChange: setIndustryFilter,
            options: [
                { value: "all", label: "ŸáŸÖŸá ÿµŸÜÿß€åÿπ" },
                ...Object.entries(INDUSTRY_CONFIG).map(([key, config]) => ({
                    value: key,
                    label: config.label,
                })),
            ],
        },
    ];

    // Brand Card Component
    const BrandCard = ({ brand }) => (
        <Card sx={{ height: "100%", transition: "transform 0.2s", "&:hover": { transform: "translateY(-4px)" } }}>
            <CardContent>
                <Box sx={{ textAlign: "center", mb: 2 }}>
                    <Avatar src={brand.logo} variant="rounded" sx={{ width: 80, height: 80, mx: "auto", mb: 2 }}>
                        <Business sx={{ fontSize: 40 }} />
                    </Avatar>

                    <Typography variant="h6" gutterBottom>
                        {brand.name}
                    </Typography>

                    <Stack direction="row" spacing={1} justifyContent="center" sx={{ mb: 2 }}>
                        <Chip label={INDUSTRY_CONFIG[brand.industry]?.label || "ŸÜÿßŸÖÿ¥ÿÆÿµ"} size="small" color={INDUSTRY_CONFIG[brand.industry]?.color || "default"} />
                        {brand.isFeatured && <Chip label="Ÿà€å⁄òŸá" size="small" color="secondary" icon={<Star />} />}
                    </Stack>
                </Box>

                {brand.description && (
                    <Typography variant="body2" sx={{ mb: 2, fontSize: "0.875rem", textAlign: "center" }}>
                        {brand.description.length > 100 ? `${brand.description.substring(0, 100)}...` : brand.description}
                    </Typography>
                )}

                <Box sx={{ mb: 2 }}>
                    {brand.contactPerson && (
                        <Typography variant="caption" display="block">
                            üë§ {brand.contactPerson}
                        </Typography>
                    )}
                    {brand.email && (
                        <Typography variant="caption" display="block">
                            üìß {brand.email}
                        </Typography>
                    )}
                    {brand.phone && (
                        <Typography variant="caption" display="block">
                            üìû {brand.phone}
                        </Typography>
                    )}
                </Box>

                {brand.rating && (
                    <Box sx={{ textAlign: "center", mb: 2 }}>
                        <Rating value={brand.rating} readOnly size="small" precision={0.5} />
                        <Typography variant="caption" display="block" color="text.secondary">
                            {brand.projectsCount || 0} Ÿæÿ±Ÿà⁄òŸá ÿßŸÜÿ¨ÿßŸÖ ÿ¥ÿØŸá
                        </Typography>
                    </Box>
                )}

                {/* Social Media Links */}
                {(brand.socialMedia?.linkedin || brand.socialMedia?.twitter || brand.socialMedia?.instagram) && (
                    <Stack direction="row" spacing={1} justifyContent="center" sx={{ mb: 2 }}>
                        {brand.socialMedia?.linkedin && (
                            <IconButton size="small" component={Link} href={brand.socialMedia.linkedin} target="_blank">
                                <LinkedIn fontSize="small" />
                            </IconButton>
                        )}
                        {brand.socialMedia?.twitter && (
                            <IconButton size="small" component={Link} href={brand.socialMedia.twitter} target="_blank">
                                <Twitter fontSize="small" />
                            </IconButton>
                        )}
                        {brand.socialMedia?.instagram && (
                            <IconButton size="small" component={Link} href={brand.socialMedia.instagram} target="_blank">
                                <Instagram fontSize="small" />
                            </IconButton>
                        )}
                    </Stack>
                )}

                <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <Stack direction="row" spacing={0.5}>
                        {brand.website && (
                            <IconButton size="small" onClick={() => window.open(brand.website, "_blank")}>
                                <Language fontSize="small" />
                            </IconButton>
                        )}
                        <IconButton size="small" onClick={() => handleEdit(brand)}>
                            <Edit fontSize="small" />
                        </IconButton>
                        <IconButton size="small" onClick={() => handleDelete(brand)}>
                            <Delete fontSize="small" />
                        </IconButton>
                    </Stack>

                    <Chip label={COMPANY_SIZES[brand.companySize]?.label || "ŸÜÿßŸÖÿ¥ÿÆÿµ"} size="small" color={COMPANY_SIZES[brand.companySize]?.color || "default"} variant="outlined" />
                </Box>
            </CardContent>
        </Card>
    );

    return (
        <Layout>
            <Box>
                <Box sx={{ mb: 3, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <Box>
                        <Typography variant="h4" fontWeight="bold">
                            ŸÖÿØ€åÿ±€åÿ™ ÿ®ÿ±ŸÜÿØŸáÿß
                        </Typography>
                        <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                            ŸÖÿØ€åÿ±€åÿ™ ÿ®ÿ±ŸÜÿØŸáÿß Ÿà ŸÖÿ¥ÿ™ÿ±€åÿßŸÜ ÿ¢⁄òÿßŸÜÿ≥
                        </Typography>
                    </Box>

                    <Stack direction="row" spacing={2}>
                        <Button variant={viewMode === "table" ? "contained" : "outlined"} onClick={() => setViewMode("table")} size="small">
                            ÿ¨ÿØŸàŸÑ
                        </Button>
                        <Button variant={viewMode === "cards" ? "contained" : "outlined"} onClick={() => setViewMode("cards")} size="small">
                            ⁄©ÿßÿ±ÿ™‚ÄåŸáÿß
                        </Button>
                        <Button variant="contained" startIcon={<Add />} onClick={handleAdd}>
                            ÿ®ÿ±ŸÜÿØ ÿ¨ÿØ€åÿØ
                        </Button>
                    </Stack>
                </Box>

                {viewMode === "table" ? (
                    <DataTable
                        title="ŸÑ€åÿ≥ÿ™ ÿ®ÿ±ŸÜÿØŸáÿß"
                        data={brandsData?.data || []}
                        columns={columns}
                        loading={isLoading}
                        pagination={brandsData?.pagination}
                        onSearch={handleSearch}
                        onEdit={handleEdit}
                        onAdd={handleAdd}
                        searchPlaceholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà ÿØÿ± ÿ®ÿ±ŸÜÿØŸáÿß (ÿ≠ÿØÿßŸÇŸÑ 3 ⁄©ÿßÿ±ÿß⁄©ÿ™ÿ±)..."
                        enableSelection={true}
                        customActions={customActions}
                        filters={filters}
                    />
                ) : (
                    <Box>
                        <Grid container spacing={3}>
                            {(brandsData?.data || []).map((brand) => (
                                <Grid item xs={12} sm={6} md={4} lg={3} key={brand._id}>
                                    <BrandCard brand={brand} />
                                </Grid>
                            ))}
                        </Grid>

                        {(!brandsData?.data || brandsData.data.length === 0) && !isLoading && (
                            <Box sx={{ textAlign: "center", py: 8 }}>
                                <Business sx={{ fontSize: 64, color: "text.secondary", mb: 2 }} />
                                <Typography variant="h6" color="text.secondary" gutterBottom>
                                    ÿ®ÿ±ŸÜÿØ€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ
                                </Typography>
                                <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
                                    ÿßŸàŸÑ€åŸÜ ÿ®ÿ±ŸÜÿØ ÿÆŸàÿØ ÿ±ÿß ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ€åÿØ
                                </Typography>
                                <Button variant="contained" startIcon={<Add />} onClick={handleAdd}>
                                    ÿßŸÅÿ≤ŸàÿØŸÜ ÿ®ÿ±ŸÜÿØ ÿ¨ÿØ€åÿØ
                                </Button>
                            </Box>
                        )}
                    </Box>
                )}

                {/* Brand Form Modal */}
                <Modal open={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingBrand ? "Ÿà€åÿ±ÿß€åÿ¥ ÿ®ÿ±ŸÜÿØ" : "ÿßŸÅÿ≤ŸàÿØŸÜ ÿ®ÿ±ŸÜÿØ ÿ¨ÿØ€åÿØ"} maxWidth="md" fullWidth>
                    <BrandForm brand={editingBrand} onSave={handleSaveBrand} onCancel={() => setIsModalOpen(false)} />
                </Modal>
            </Box>
        </Layout>
    );
}
